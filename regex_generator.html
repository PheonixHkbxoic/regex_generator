<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>正则自动生成器</title>
	<style type="text/css">
		html,body{
			margin:0px;
			padding:0px;
			color:white;/*#065a5c;*/
		}
		body{
			padding:10px;
		}
		.border{
			border:1px solid green;
		}
		.add-border-top-green{
			border-top:1px solid green;
		}
		h1,h3{
			text-align:center;
			color:darkgreen;
			background:#f5f5f5;
			opacity:0.8;
			padding:5px;
		}
		#start_generate:hover{
			cursor:pointer;
			background:#eee;
			color:purple;
			border-radius:2px;
		}
		.condition{
			position:relative;
			margin:0px;
			padding:0px;
			background: #2C3B41;
			filter:alpha(Opacity=80);
			-moz-opacity:0.8;
			opacity: 0.8;
			border-radius:10px;
			
		}
		#author{
			display: inline-block;
			position:absolute;
			right:10px;
			top:10px;
			color:purple;
		}
		.tools{
			margin:1%;
		}
		.tools>div{
			display:inline-block;
			margin: 5px;
		}
		.io{
			text-align:left;
			with:100%;
		}
		.io-item{
			display: inline-block;
			margin:1%;
		}
		.io-item>textarea{
			width:100%;
			overflow:auto;
 			word-break:break-all;
 			height: 300px;
		}
	</style>
</head>
<body>
	<div class="condition">
		<h1>正则自动生成器</h1><label id="author">by cn.pheker</label>
		<div class="tools">
			<div class="language">
				<label>语言:</label>
				<select id="language_select">
					<option value="c/c++">c/c++</option>
					<option value="java">java</option>
					<option value="php">php</option>
					<option value="js">js</option>
					<option value="python">python</option>
					<option value="ruby">ruby</option>
				</select>
			</div>
			<div class="constant">
				<label>常量:</label>
				<input type="text" id="txt_constant" placeholder="请输入正则常量">
			</div>
		</div>
		
		<div class="io add-border-top-green">
			<div class="io-item" style="width:30%;">
				<h3>正确实例</h3>
				<textarea id="txt_right" class="border"  placeholder="请输入正确的正则例子"></textarea>
			</div>
			<div class="io-item" style="width:30%;">
				<h3>错误实例</h3>
				<textarea id="txt_error" placeholder="请输入错误的正则例子"></textarea>
			</div>
			<div class="io-item" style="width:30%;">
				<h3 id="start_generate">生成正则</h3>
				<textarea id="txt_regex" rows="20" cols="30" placeholder="这里将显示生成的正则表达式" onpropertychange="this.style.posHeight=this.scrollHeight"></textarea>
			</div>
		</div>

		<!-- 正则功能区 -->
		<div class="function add-border-top-green">
			<div class="io-item" style="width:20%;">
				<h3>匹配</h3>
				<textarea id="txt_test" placeholder="待开发"></textarea>
			</div>
			<div class="io-item" style="width:20%;">
				<h3>替换</h3>
				<textarea id="txt_replace" placeholder="待开发"></textarea>
			</div>
			<div class="io-item" style="width:20%;">
				<h3>转换</h3>
				<textarea id="txt_convert" placeholder="待开发" onpropertychange="this.style.posHeight=this.scrollHeight"></textarea>
			</div>
			<div class="io-item" style="width:20%;">
				<h3>库</h3>
				<textarea id="txt_convert" placeholder="待开发" onpropertychange="this.style.posHeight=this.scrollHeight"></textarea>
			</div>
		</div>
	</div>
	<script src="https://cdn.bootcss.com/jquery/3.2.0/jquery.js"></script>
	<script type="text/javascript">

		//全局变量
		var vars = {
			languages:["c/c++","java","php","js","python","ruby"],//语言
			ids:["txt_right","txt_error"],//ids:正确实例,错误实例
			tools:[],	//工具区文本:语言,常量
			txts:[],	//文本:正确实例,错误实例,生成的正则实例
			regexs:[],	//生成的正则
			judgeType:{
				isDigit:function(character){			//是否是数字
					return /\d/.test(character)?true:false;
				},
				isLowerCase:function(character){		//是否是小写字母
					return /[a-z]/.test(character)?true:false;
				},
				isUpperCase:function(character){		//是否是大写字母
					return /[A-Z]/.test(character)?true:false;
				},
				isLetter:function(character){
					return this.isLowerCase(character)||this.isUpperCase(character);
				},
				isRegexMetaCharacter:function(character){//是否是正则元字符
					return /[\.\*\+\?\[\]\(\)\{\}\-\\]/.test(character)?true:false;
				},
				isOther:function(character){
					return !(this.isDigit(character)
						||this.isLetter(character)
						||this.isRegexMetaCharacter(character));
				}
			}
		}
			
		$(document).ready(function(){
		
		//change
		//工具区
			//语言
			$("#language_select").change(function() {
			    $("#language_select option:selected").each(function () {
			        vars.tools[0] = $(this).text();
			        dealText();
			    });
			})
			$("#txt_constant").on('input propertychange',function(){
				var text = $(this).val();
				vars.tools[1] = text?text.split("##"):[];
				dealText();
			})
			
			//正确实例,错误实例
			$.each(vars.ids,function(index,id){
				var ta = $("#"+id);
				ta.on('input propertychange',function(){
					vars.txts[index] = ta.val();
					dealText();
				})
			})
			//生成正则按钮
			$("#start_generate").click(function(){
				dealText();
			})

			//逻辑处理
			function dealText(tools,txts){
				//获取语言,常量,正确实例,错误实例,
				vars.tools[0] = $("#language_select option:selected").text();
				vars.tools[1] = $("#txt_constant").val();
				vars.txts[0] = $("#txt_right").val();
				vars.txts[1] = $("#txt_right").val();
				console.log(vars);
				
				var constant = vars.tools[1];
				var regex = constant;

				vars.regexs[0] = regex;

			//没有考虑常量的情况下
				//正确实例字符数组
				var reg_example_rights = vars.txts[0]?vars.txts[0].split("\n"):[];
				// console.log(reg_example_rights)
				//重构数组为 按索引划分的数组
				var arrAtIndex = toArrByIndex(reg_example_rights);
				// console.log(arrAtIndex)
				//每个索引位置 生成各自 正则数组
				var regArr = []; //生成的正则字符数组 二维
				arrAtIndex.forEach(function(v,i,rer){
					var uniqueArr = uniqueStr(v).split("");
					// console.log(uniqueArr);
					regArr.push(generateRegArrAtIndex(uniqueArr));
				});
				// console.log(regArr);

				//组合正则
				var assembledArr = assembleRegArr(regArr);
				console.log(assembledArr);
				//优化正则
					var optimizedArr = noRepeat(assembledArr);

				//显示正则
				// $("#txt_regex").val(vars.regexs.join("\n"));
				 $("#txt_regex").val(assembledArr.join("\n"));

			}
		});

		//将字符数组=>按照索引生成数组
		function toArrByIndex(arrs){
			var maxLen = 0;
			arrs.forEach(function(v,i,rer){
				maxLen = maxLen<v.length?v.length:maxLen;
			});
			var ret = new Array(maxLen);
			for(var i=0;i<arrs.length;i++){
				var item = arrs[i].split("");
				item.forEach(function(v,j,rer){
					var old = ret[j]?ret[j]:"";
					ret[j] = old+(v?v:"");
				});
			}
			return ret;
		}

		//生成指定索引位置的正则数组
		function generateRegArrAtIndex(uniqueArr){
			var regArrAtIndex = uniqueArr;
			regArrAtIndex = escapeMetaCharacter(regArrAtIndex);
			uniqueArr.forEach(function(v,i,arr){
				var metacharacter = "";
				if(vars.judgeType.isDigit(v)){
					metacharacter = "\\d";
				}else if(vars.judgeType.isLetter(v)){
					metacharacter = "[a-zA-Z]";
				}else if(vars.judgeType.isRegexMetaCharacter(v)){
					metacharacter = "[\\.\\*\\+\\?\\[\\]\\(\\)\\{\\}\\\\\\-]";
				}else if(vars.judgeType.isOther(v)){
					metacharacter = v;
				}
				// console.log("reg_metacharacter:"+metacharacter);
				if(!contains(regArrAtIndex,metacharacter)){
					regArrAtIndex.push(metacharacter);
				}
			});
			return regArrAtIndex;
		}

		//字符串去重
		function uniqueStr(str){
	    	var newArr=[];  
	        var arr = str.split("");
	        arr.forEach(function(v,j,arrrrr){
	        	if(!contains(newArr,v)){
	        		newArr.push(v);
	        	}
	        });
		    return newArr.join("");
		}
		
		//数组是否包含某个元素
		function contains(arr,v) {
		  for (i in arr) {
		    if (arr[i] == v) return true;
		  }
		  return false;
		}

		//组合正则数组
		function assembleRegArr(regArr){
			var assembledArr = [];
			regArr.forEach(function(v,i,arr){
				var typeArr = v;
				if(i==0){
					assembledArr = typeArr;
				}else{
					var tempArr = [];
					assembledArr.forEach(function(v1,i1,arr1){
						typeArr.forEach(function(v2,i2,arr2){
					 		tempArr.push(v1+v2+"");
						});
					});
					assembledArr = tempArr;
				}
				
			});
			return assembledArr;
		}

		//过滤掉含有元字符的数组
		function filterMetaCharacterInRightRegArr(regArr){
			return regArr.filter(function(v,i,arr){
				return !v.match(/[\.\*\+\?\[\]\(\)\{\}\\\-]/g);
			});
		}
		//转义元字符或元字符数组
		function escapeMetaCharacter(regArr){
			if(isArr(regArr)){
	          	regArr = regArr.map(function(v,i,arr){
	            	return v.replace(/([\.\*\+\?\[\]\(\)\{\}\\\-])/g,"\\$1");
	          	});
	      	}else{
	        	regArr = regArr.replace(/([\.\*\+\?\[\]\(\)\{\}\\\-])/g,"\\$");
	      	}
  			return regArr;
		}
		
		//合并重复组合 不包括\\
		function noRepeat(optimizedArr){
			optimizedArr = optimizedArr.map(function(v,i,arr){
				return v.replace(/([^\\]([^\\]))\2+/g,"$1+")		//dd非\dd类型
						.replace(/(\\[^\\]){2,}/g, "\\$1+")			//\d\d类型 似乎无法去掉
						.replace(/(\[a-zA-Z\]){2,}/mg, "$1+");		//[a-zA-Z\] 好像也不行
			});
      		return optimizedArr;
		}
		//判断是否是数组
		function isArr(arr){
		    return Object.prototype.toString.call(arr) === '[object Array]'; 
		}
	</script>
</body>
</html>
